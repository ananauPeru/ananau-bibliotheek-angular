<ng-container *ngIf="exercise$ | async as exercise; else loading">
  <div class="card card-custom">
    <!-- Header -->
    <div class="row">
      <div class="col-12">
        <div class="card-header border-0 text-white" style="background-color: white; padding: 2rem 2.25rem">
          <div class="row">
            <div class="col-12 d-flex justify-content-between">
              <h3 class="card-title font-weight-bolder text-dark">
                {{ exercise.title }}
              </h3>
              <div class="d-flex align-items-center">




                <button
                  *ngIf="AuthUtil.permitted([AuthUtil.roles.SuperAdmin, AuthUtil.roles.SpanishTeacher])"
                  class="btn btn-secondary order-1 order-md-2 mr-2"
                  (click)="openAssignModal()"
                >
                  <span class="d-none d-md-inline ml-1">Create assign</span>
                </button>








                <button *ngIf="AuthUtil.permitted([AuthUtil.roles.SuperAdmin, AuthUtil.roles.SpanishTeacher])" class="btn btn-secondary order-1 order-md-2 mr-2" routerLink="/exercise/list">
                  Back to List
                </button>
                <ng-template #student_back_nav>
                  <button class="btn btn-secondary order-1 order-md-2 mr-2" routerLink="/exercise/shared">
                    Back to List
                  </button>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Body -->
    <div class="card-body pt-2">
      <div class="row">
        <div class="col-12">
          <p class="mb-4"><strong>Type:</strong> {{ exercise.type.name }}</p>
        </div>
        <div class="col-12">
          <p class="mb-4">{{ exercise.description || "No description" }}</p>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex justify-content-between">
            <h4>Files</h4>
            <button
              class="btn btn-primary mb-2"
              (click)="downloadAllFiles(exercise.fileUrls)"
            >
              Download All Files
            </button>
          </div>
          <ul class="list-group">
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
              *ngFor="let file of exercise.fileUrls; let i = index"
            >
              {{ fileUrlToName(file) }}
              <button class="btn btn-primary" (click)="downloadFile(file)">
                Download
              </button>
            </li>
          </ul>
        </div>
      </div>

      <ng-container *ngIf="exercise.type.id != 2">
        <div class="row mt-4" *ngIf="exercise.submissions as submissions">
          <div class="col-12">
            <h4>Submissions</h4>
            <ng-container *ngIf="submissions.length > 0; else noSubmissions">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th
                        *ngIf="
                          AuthUtil.permitted([
                            AuthUtil.roles.SuperAdmin,
                            AuthUtil.roles.SpanishTeacher
                          ])
                        "
                      >
                        Submitted By
                      </th>
                      <th>Submission Date</th>
                      <th>Grade</th>
                      <th>Graded By</th>
                      <th>Grading Date</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let submission of submissions">
                      <td
                        *ngIf="
                          AuthUtil.permitted([
                            AuthUtil.roles.SuperAdmin,
                            AuthUtil.roles.SpanishTeacher
                          ])
                        "
                      >
                        {{ submission.submittedBy.firstName }}
                        {{ submission.submittedBy.lastName }}
                      </td>
                      <td>{{ submission.submittedAt | date : "medium" }}</td>
                      <td>{{ getGradeText(exercise, submission) }}</td>
                      <td>{{ getGradedByText(submission) }}</td>
                      <td>
                        {{
                          submission.gradedAt
                            ? (submission.gradedAt | date : "medium")
                            : "Not graded yet"
                        }}
                      </td>
                      <td>
                        <button
                          class="btn btn-primary"
                          routerLink="/exercise/submission/overview/{{
                            submission.id
                          }}"
                        >
                          Details
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </ng-container>
            <ng-template #noSubmissions>
              <p>No submissions yet</p>
            </ng-template>
          </div>
        </div>

        <ng-template #loadingSubmissions>
          <h4>Submissions</h4>
          <div class="d-flex justify-content-center align-items-center">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
        </ng-template>

        <!-- Learner -->
        <div
          *ngIf="AuthUtil.permitted([AuthUtil.roles.SpanishLearner])"
          class="row"
        >
          <div class="col-12">
            <h4>Submit Exercise</h4>
            <ng-container
              *ngIf="!isPassedSubmissionDate(exercise); else pastSubmissionDate"
            >
              <form [formGroup]="submissionForm">
                <div
                  class="form-group"
                  *ngIf="!isLoading; else loadingDropzone"
                >
                  <div
                    #dropzone
                    class="custom-dropzone form-control form-control-solid border"
                    ngx-dropzone
                    (change)="onSelectFiles($event)"
                    [class.is-invalid]="
                      submissionForm.get('files').invalid &&
                      (submissionForm.get('files').dirty ||
                        submissionForm.get('files').touched)
                    "
                  >
                    <ngx-dropzone-label>
                      <p class="form-text text-muted">
                        {{ "REGISTRATION.SCANS.DROP_SELECT" | translate }}
                      </p>
                    </ngx-dropzone-label>
                    <ngx-dropzone-image-preview
                      ngProjectAs="ngx-dropzone-preview"
                      *ngFor="let f of submissionFiles"
                      [file]="f"
                      [removable]="true"
                      (removed)="onRemoveFile(f)"
                    >
                    </ngx-dropzone-image-preview>
                  </div>
                  <small
                    class="text-danger"
                    *ngIf="
                      submissionForm.get('files').invalid &&
                      (submissionForm.get('files').dirty ||
                        submissionForm.get('files').touched)
                    "
                  >
                    At least one file is required.
                  </small>
                </div>
                <ng-template #loadingDropzone>
                  <div
                    class="d-flex justify-content-center align-items-center"
                    style="height: 200px"
                  >
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                  </div>
                </ng-template>
                <div class="form-group">
                  <textarea
                    class="form-control"
                    rows="3"
                    placeholder="Add a comment"
                    formControlName="comment"
                  ></textarea>
                </div>
                <button
                  class="btn btn-primary"
                  (click)="submitExercise(exercise)"
                  [disabled]="submissionForm.invalid || isLoading"
                >
                  Submit
                </button>
              </form>
            </ng-container>
            <ng-template #pastSubmissionDate>
              <p class="text-danger">
                The deadline for this exercise has passed
              </p>
            </ng-template>
          </div>
        </div>
      </ng-container>

      <div
        *ngIf="
          AuthUtil.permitted([
            AuthUtil.roles.SpanishTeacher,
            AuthUtil.roles.SuperAdmin
          ])
        "
      >
        <!-- Teacher View -->
        <!-- Implement the teacher view here -->
      </div>
    </div>
  </div>
</ng-container>

<ng-template #loading>
  <div
    class="d-flex justify-content-center align-items-center"
    style="height: 100vh"
  >
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
</ng-template>

<!-- Assign Modal -->
<ng-template #assignModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Create Assignment</h5>
    <button
      type="button"
      class="close"
      (click)="modal.dismiss()"
      aria-label="Close"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form [formGroup]="assignForm">
      <div class="form-group row align-items-center">
        <label class="col-12 col-md-5 font-weight-bold mb-2 mb-md-0"
          >Deadline Date</label>
        <div class="col-12 col-md-7">
          <input
            type="date"
            class="form-control form-control-solid"
            formControlName="deadline"
            required
          />
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer d-flex">
    <button
      type="button"
      class="btn btn-secondary ml-auto"
      (click)="modal.dismiss()"
    >
      {{ "BUTTONS.CANCEL" | translate }}
    </button>
    <button type="button" class="btn btn-primary" (click)="saveAssign()">
      {{ "BUTTONS.SAVE" | translate }}
    </button>
  </div>
</ng-template>
